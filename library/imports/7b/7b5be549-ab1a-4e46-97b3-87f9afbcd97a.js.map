{"version":3,"sources":["../../../../../../assets/script/wx/utils/assets/script/wx/utils/util.js"],"names":["tokenMgr","require","urls","md5","config","global","WXBizDataCrypt","formatTime","year","date","getFullYear","month","getMonth","day","getDate","hour","getHours","minute","getMinutes","second","getSeconds","map","formatNumber","join","n","toString","randomStr","chars","split","res","i","Math","random","length","getSession","callback","wx","login","success","console","log","code","request","url","data","appid","secret","appsecret","js_code","grant_type","sessionkey","session_key","fail","decodeOpenId","checkSession","pc","decryptData","encryptedData","iv","openGId","getLocalOpenID","UID","openid","reLogin","param","getParam","sign","d","ecode","reloginGetUserInfo","user","method","setUserDataInfo","gamecenter_link","p","err","header","dataType","complete","checkToken","token","getToken","setToken","statusCode","error","key","appId","list","Array","item","type","tmp","push","sort","o0","o1","getXMLNodeValue","node_name","xml","_tmp","randomString","maxPos","pwd","charAt","floor","createTimeStamp","parseInt","Date","getTime","_pay","fee","url_unifiedOrder","unifiedOrder","wx_unifiedOrder","JSON","stringify","return_code","returnCode","err_code_des","errDes","prepay_id","tmp1","timeStamp","nonceStr","dat","package","signType","paySign","toUpperCase","requestPayment","pay","args","module","exports"],"mappings":";;;;;;;;AAAA,IAAIA,WAAWC,QAAQ,UAAR,CAAf;AACA,IAAIC,OAAOD,QAAQ,QAAR,EAAkBC,IAA7B;AACA,IAAIC,MAAMF,QAAQ,KAAR,CAAV;AACA,IAAIG,SAASH,QAAQ,QAAR,CAAb;AACA,IAAII,SAASJ,QAAQ,kBAAR,CAAb;AACA,IAAIK,iBAAiBL,QAAQ,gBAAR,CAArB;;AAEA,IAAMM,aAAa,SAAbA,UAAa,OAAQ;AACvB,QAAMC,OAAOC,KAAKC,WAAL,EAAb;AACA,QAAMC,QAAQF,KAAKG,QAAL,KAAkB,CAAhC;AACA,QAAMC,MAAMJ,KAAKK,OAAL,EAAZ;AACA,QAAMC,OAAON,KAAKO,QAAL,EAAb;AACA,QAAMC,SAASR,KAAKS,UAAL,EAAf;AACA,QAAMC,SAASV,KAAKW,UAAL,EAAf;;AAEA,WAAO,CAACZ,IAAD,EAAOG,KAAP,EAAcE,GAAd,EAAmBQ,GAAnB,CAAuBC,YAAvB,EAAqCC,IAArC,CAA0C,GAA1C,IAAiD,GAAjD,GAAuD,CAACR,IAAD,EAAOE,MAAP,EAAeE,MAAf,EAAuBE,GAAvB,CAA2BC,YAA3B,EAAyCC,IAAzC,CAA8C,GAA9C,CAA9D;AACH,CATD;;AAWA,IAAMD,eAAe,SAAfA,YAAe,IAAK;AACtBE,QAAIA,EAAEC,QAAF,EAAJ;AACA,WAAOD,EAAE,CAAF,IAAOA,CAAP,GAAW,MAAMA,CAAxB;AACH,CAHD;;AAKA,IAAME,YAAY,SAAZA,SAAY,IAAK;AACnB,QAAMC,QAAQ,uCAAuCC,KAAvC,CAA6C,EAA7C,CAAd;AACA,QAAIC,MAAM,EAAV;AACA,SAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIN,CAApB,EAAuBM,GAAvB,EAA4B;AACxBD,cAAMA,MAAMF,MAAM,CAACI,KAAKC,MAAL,KAAgB,GAAhB,GAAsB,CAAvB,IAA4BL,MAAMM,MAAxC,CAAZ;AACH;AACD,WAAOJ,GAAP;AACH,CAPD;;AASA;AACA,IAAMK,aAAa,SAAbA,UAAa,CAAUC,QAAV,EAAoB;AACnCC,OAAGC,KAAH,CAAS;AACLC,iBAAS,sBAAO;AACZC,oBAAQC,GAAR,CAAY,mBAAZ,EAAiCX,GAAjC;AACA,gBAAIY,OAAOZ,IAAIY,IAAf;AACAL,eAAGM,OAAH,CAAW;AACPC,qBAAK,8CADE;AAEPC,sBAAM;AACFC,2BAAOzC,OAAOA,MAAP,CAAcyC,KADnB;AAEFC,4BAAQ1C,OAAOA,MAAP,CAAc2C,SAFpB;AAGFC,6BAASP,IAHP;AAIFQ,gCAAY;AAJV,iBAFC;AAQPX,yBAAS,sBAAO;AACZC,4BAAQC,GAAR,CAAY,0BAAZ,EAAwCX,GAAxC;AACA;AACAzB,2BAAO8C,UAAP,GAAoBrB,IAAIe,IAAJ,CAASO,WAA7B;AACA,wBAAIhB,YAAY,OAAOA,QAAP,IAAmB,UAAnC,EAA+C;AAC3CA;AACH;AACJ,iBAfM;AAgBPiB,sBAAM,mBAAO;AACTb,4BAAQC,GAAR,CAAY,uBAAZ,EAAqCX,GAArC;AACH;AAlBM,aAAX;AAoBH,SAxBI;AAyBLuB,cAAM,mBAAO;AACTb,oBAAQC,GAAR,CAAY,gBAAZ,EAA8BX,GAA9B;AACH;AA3BI,KAAT;AA6BH,CA9BD;;AAgCA,IAAMwB,eAAe,SAAfA,YAAe,CAAUxB,GAAV,EAAeM,QAAf,EAAyB;AAC1CmB,iBAAa,YAAY;AACrBf,gBAAQC,GAAR,CAAY,oBAAZ,EAAkCpC,OAAO8C,UAAzC;AACA,YAAI9C,OAAO8C,UAAP,IAAqB9C,OAAO8C,UAAP,IAAqB,EAA9C,EAAkD;AAC9C,gBAAIK,KAAK,IAAIjD,cAAJ,CAAmBF,OAAOA,MAAP,CAAcyC,KAAjC,EAAwCzC,OAAO8C,UAA/C,CAAT;AACA,gBAAIN,OAAOW,GAAGC,WAAH,CAAe3B,IAAI4B,aAAnB,EAAkC5B,IAAI6B,EAAtC,CAAX;AACAnB,oBAAQC,GAAR,CAAY,aAAZ,EAA2BI,IAA3B;AACA,gBAAGA,QAAQA,KAAK,SAAL,CAAX,EAA2B;AACvB;AACA,oBAAIT,YAAY,OAAOA,QAAP,IAAmB,UAAnC,EAA+C;AAC3CA,6BAASS,KAAKe,OAAd;AACH;AACJ;AACJ;AACJ,KAbD;AAcH,CAfD;;AAiBA,IAAML,eAAe,SAAfA,YAAe,CAAUnB,QAAV,EAAoB;AACrCC,OAAGkB,YAAH,CAAgB;AACZhB,iBAAS,sBAAO;AACZC,oBAAQC,GAAR,CAAY,uBAAZ,EAAqCX,GAArC;AACA,gBAAIzB,OAAO8C,UAAP,IAAqB,EAAzB,EAA6B;AACzBhB,2BAAWC,QAAX;AACH,aAFD,MAEO;AACH,oBAAIA,YAAY,OAAOA,QAAP,IAAmB,UAAnC,EAA+C;AAC3CA;AACH;AACJ;AACD;AACA;AACA;;AAEA;AACH,SAfW;AAgBZiB,cAAM,mBAAO;AACTb,oBAAQC,GAAR,CAAY,oBAAZ,EAAkCX,GAAlC;AACAK,uBAAWC,QAAX;AACH;AAnBW,KAAhB;AAqBH,CAtBD;AAuBA;;;;AAIA,IAAMyB,iBAAiB,SAAjBA,cAAiB,CAASnB,IAAT,EAAc;AACjCL,OAAGM,OAAH,CAAW;AACPC,aAAK,8CADE;AAEPC,cAAM;AACFC,mBAAOzC,OAAOA,MAAP,CAAcyC,KADnB;AAEFC,oBAAQ1C,OAAOA,MAAP,CAAc2C,SAFpB;AAGFC,qBAASP,IAHP;AAIFQ,wBAAY;AAJV,SAFC;AAQPX,iBAAS,sBAAO;AACZC,oBAAQC,GAAR,CAAY,0BAAZ,EAAwCX,GAAxC;AACA;AACAzB,mBAAO8C,UAAP,GAAoBrB,IAAIe,IAAJ,CAASO,WAA7B;AACA/C,mBAAOyD,GAAP,GAAahC,IAAIe,IAAJ,CAASkB,MAAtB;AAEH,SAdM;AAePV,cAAM,mBAAO;AACTb,oBAAQC,GAAR,CAAY,uBAAZ,EAAqCX,GAArC;AACH;AAjBM,KAAX;AAmBH,CApBD;;AAsBA,IAAMkC,UAAS,SAATA,OAAS,GAAU;AACrB3B,OAAGC,KAAH,CAAS;AACLC,iBAAQ,sBAAK;AACT,gBAAI0B,QAAQ5D,OAAO6D,QAAP,EAAZ;AACAD,kBAAM,SAAN,IAAmBE,KAAKF,KAAL,CAAnB;AACAA,kBAAM,SAAN,IAAmBnC,IAAIY,IAAvB;AACAC,oBAAQ;AACJC,qBAAKvC,OAAOF,IAAP,CAAYmC,KADb;AAEJO,sBAAKoB,KAFD;AAGJ1B,yBAAS,iBAAUT,GAAV,EAAe;AACpBU,4BAAQC,GAAR,CAAY,SAAZ,EAAsBX,GAAtB;AACA,wBAAGA,IAAIe,IAAJ,CAAS,KAAT,CAAH,EAAmB;AACf,4BAAIuB,IAAItC,IAAIe,IAAZ;AACA,4BAAIuB,MAAMA,EAAEC,KAAF,IAAW,CAAX,IAAgBD,EAAEC,KAAF,IAAW,CAAjC,CAAJ,EAAyC;AACrC7B,oCAAQC,GAAR,CAAY,SAAZ,EAAsBX,GAAtB;AACA,gCAAGA,IAAIe,IAAJ,CAAS,KAAT,CAAH,EAAmB;AACfxC,uCAAOyD,GAAP,GAAahC,IAAIe,IAAJ,CAAS,KAAT,CAAb;AACH;AACD,gCAAGf,IAAIe,IAAJ,CAAS,YAAT,CAAH,EAA0B;AACtBxC,uCAAO8C,UAAP,GAAoBrB,IAAIe,IAAJ,CAASM,UAA7B;AACH;AACDmB;AACH;AACJ;AACJ;AAlBG,aAAR;AAoBH,SAzBI;AA0BLjB,cAAK,mBAAK;AACNb,oBAAQC,GAAR,CAAYX,GAAZ;AACH;AA5BI,KAAT;AA8BH,CA/BD;;AAiCA,IAAMwC,qBAAqB,SAArBA,kBAAqB,GAAU;AACjC,QAAI1B,MAAMvC,OAAOF,IAAP,CAAYoE,IAAZ,GAAkB,WAA5B;AACA,QAAIN,QAAQ,EAAZ,CAFiC,CAElB;AACftB,YAAQ;AACJC,aAAKA,GADD;AAEJC,cAAMoB,KAFF;AAGJO,gBAAQ,KAHJ;AAIJjC,iBAAQ,sBAAK;AACT;AACAC,oBAAQC,GAAR,CAAY,aAAZ,EAA0BX,GAA1B;AACAxB,mBAAOmE,eAAP,CAAuB3C,IAAIe,IAAJ,CAASA,IAAhC;AACH;AARG,KAAR;AAUH,CAbD;;AAeA,IAAMF,UAAU,SAAVA,OAAU,IAAK;AACjB,QAAG,CAAC,CAAC,CAACtC,OAAOqE,eAAb,EAA6B;AACzB,YAAIrB,QAAOsB,EAAEtB,IAAF,IAAU,UAASuB,GAAT,EAAc,CAAE,CAArC;AACAvB;AACA;AACH;AACD,QAAIT,MAAM+B,EAAE/B,GAAZ;AACA,QAAIC,OAAO8B,EAAE9B,IAAF,IAAU,EAArB;AACA,QAAIgC,SAASF,EAAEE,MAAF,IAAY,EAAzB;AACA,QAAIL,SAASG,EAAEH,MAAF,IAAY,KAAzB;AACA,QAAIM,WAAWH,EAAEG,QAAF,IAAc,EAA7B;AACA,QAAIvC,WAAUoC,EAAEpC,OAAF,IAAa,UAAST,GAAT,EAAc,CAAE,CAA3C;AACA,QAAIuB,QAAOsB,EAAEtB,IAAF,IAAU,UAASuB,GAAT,EAAc,CAAE,CAArC;AACA,QAAIG,WAAWJ,EAAEI,QAAF,IAAc,YAAW,CAAE,CAA1C;AACA,QAAI9E,SAAS+E,UAAT,EAAJ,EAA2B;AACvBH,eAAOI,KAAP,GAAehF,SAASiF,QAAT,EAAf;AACH,KAFD,MAEK;AACD;AACA,YAAG,CAACrC,KAAK,SAAL,CAAJ,EAAoB;AAChBmB;AACA;AACH;AACJ;AACDxB,YAAQC,GAAR,CAAYG,GAAZ,EAAgB+B,CAAhB,EAAkBE,OAAOI,KAAzB;AACA5C,OAAGM,OAAH,CAAW;AACPC,aAAKA,GADE;AAEPC,cAAMA,IAFC;AAGPgC,gBAAQA,MAHD;AAIPL,gBAAQA,MAJD;AAKPM,kBAAUA,QALH;AAMPvC,iBAAS,iBAAST,GAAT,EAAc;AACnB,gBAAGA,IAAIe,IAAJ,CAAS,OAAT,CAAH,EAAqB;AACjB5C,yBAASkF,QAAT,CAAkBrD,IAAIe,IAAJ,CAASoC,KAA3B;AACH;;AAED,gBAAInD,IAAIsD,UAAJ,IAAkB,GAAtB,EAA2B;AACvB5C,wBAAQ6C,KAAR,CAAc,iBAAd,EAAiCvD,IAAIsD,UAArC;AACA;AACH;;AAED7C,qBAAQT,GAAR;AACH,SAjBM;AAkBPuB,cAAM,cAASvB,GAAT,EAAa;AACfU,oBAAQC,GAAR,CAAY,MAAZ,EAAmBX,GAAnB;AACAuB,kBAAKvB,GAAL;AACA7B,qBAASkF,QAAT,CAAmB,IAAnB;AACH,SAtBM;AAuBPJ,kBAAUA;AAvBH,KAAX;AAyBH,CAjDD;;AAoDA,IAAMO,MAAMjF,OAAOA,MAAP,CAAc2C,SAA1B;AACA,IAAMuC,QAAQlF,OAAOA,MAAP,CAAcyC,KAA5B;;AAEA;;;;AAIA,IAAMqB,OAAO,SAAPA,IAAO,IAAK;AACd,QAAIqB,OAAO,IAAIC,KAAJ,EAAX;AACA,SAAK,IAAIC,IAAT,IAAiBf,CAAjB,EAAoB;AAChB,YAAIgB,eAAchB,EAAEe,IAAF,CAAd,CAAJ;AACA,YAAIC,QAAQ,QAAR,IAAoBA,QAAQ,QAAhC,EAA0C;AACtC,gBAAIC,MAAMF,OAAO,GAAP,GAAaf,EAAEe,IAAF,CAAvB;AACAF,iBAAKK,IAAL,CAAUD,GAAV;AACH;AACJ;AACDJ,SAAKM,IAAL,CAAU,UAASC,EAAT,EAAaC,EAAb,EAAiB;AACvB,eAAOD,KAAKC,EAAZ;AACH,KAFD;AAGAR,SAAKK,IAAL,CAAU,SAASP,GAAnB;AACA,QAAIxD,MAAM0D,KAAKhE,IAAL,CAAU,GAAV,CAAV;AACAgB,YAAQC,GAAR,CAAY,iBAAiBX,GAA7B;AACA,WAAO1B,IAAIA,GAAJ,CAAQ0B,GAAR,CAAP;AACH,CAhBD;;AAkBA,IAAMmE,kBAAkB,SAAlBA,eAAkB,CAASC,SAAT,EAAoBC,GAApB,EAAyB;AAC7C3D,YAAQC,GAAR,CAAY,SAAS0D,GAArB;AACA,QAAIP,MAAMO,IAAItE,KAAJ,CAAU,MAAMqE,SAAN,GAAkB,GAA5B,CAAV;AACA,QAAIE,OAAOR,IAAI,CAAJ,EAAO/D,KAAP,CAAa,OAAOqE,SAAP,GAAmB,GAAhC,CAAX;AACA,WAAOE,KAAK,CAAL,CAAP;AACH,CALD;;AAOA,IAAMC,eAAe,SAAfA,YAAe,GAAW;AAC5B,QAAIzE,QAAQ,kDAAZ,CAD4B,CACoC;AAChE,QAAI0E,SAAS1E,MAAMM,MAAnB;AACA,QAAIqE,MAAM,EAAV;AACA,SAAK,IAAIxE,IAAI,CAAb,EAAgBA,IAAI,EAApB,EAAwBA,GAAxB,EAA6B;AACzBwE,eAAO3E,MAAM4E,MAAN,CAAaxE,KAAKyE,KAAL,CAAWzE,KAAKC,MAAL,KAAgBqE,MAA3B,CAAb,CAAP;AACH;AACD,WAAOC,GAAP;AACH,CARD;;AAUA,IAAMG,kBAAkB,SAAlBA,eAAkB,GAAW;AAC/B,WAAOC,SAAS,IAAIC,IAAJ,GAAWC,OAAX,KAAuB,IAAhC,IAAwC,EAA/C;AACH,CAFD;;AAIA;;;;;;;AAOA,IAAMC,OAAO,SAAPA,IAAO,CAASC,GAAT,EAAcxE,SAAd,EAAuBc,IAAvB,EAA6B0B,QAA7B,EAAuC;AAChDgC,UAAMA,OAAO,CAAb;AACAxE,gBAAUA,aAAW,UAAST,GAAT,EAAc,CAAE,CAArC;AACAuB,WAAOA,QAAQ,YAAW,CAAE,CAA5B;AACA0B,eAAWA,YAAY,YAAW,CAAE,CAApC;;AAEA,QAAMiC,mBAAmB7G,KAAK8G,YAA9B;AACA,QAAMC,kBAAkB,gDAAxB;AACAvE,YAAQ;AACJC,aAAKoE,gBADD;AAEJnE,cAAM;AACFkE,iBAAKA;AADH,SAFF;AAKJxE,iBAAS,iBAAST,GAAT,EAAc;AACnBU,oBAAQC,GAAR,CAAY,kBAAkB0E,KAAKC,SAAL,CAAetF,GAAf,CAA9B;AACAa,oBAAQ;AACJC,qBAAKsE,eADD;AAEJrE,sBAAMf,IAAIe,IAFN;AAGJ2B,wBAAQ,MAHJ;AAIJjC,yBAAS,iBAAST,GAAT,EAAc;AACnB,wBAAIqE,MAAMrE,IAAIe,IAAd;AACA,wBAAIwE,cAAcpB,gBAAgB,aAAhB,EAA+BE,IAAIzE,QAAJ,CAAa,OAAb,CAA/B,CAAlB;AACA,wBAAI4F,aAAaD,YAAYxF,KAAZ,CAAkB,GAAlB,EAAuB,CAAvB,EAA0BA,KAA1B,CAAgC,GAAhC,EAAqC,CAArC,CAAjB;AACA,wBAAIyF,cAAc,MAAlB,EAA0B;AACtB,4BAAIC,eAAetB,gBAAgB,cAAhB,EAAgCnE,IAAIe,IAAJ,CAASnB,QAAT,CAAkB,OAAlB,CAAhC,CAAnB;AACA,4BAAI8F,SAASD,aAAa1F,KAAb,CAAmB,GAAnB,EAAwB,CAAxB,EAA2BA,KAA3B,CAAiC,GAAjC,EAAsC,CAAtC,CAAb;AACAwB;AACH,qBAJD,MAIO;AACH,4BAAIoE,YAAYxB,gBAAgB,WAAhB,EAA6BnE,IAAIe,IAAJ,CAASnB,QAAT,CAAkB,OAAlB,CAA7B,CAAhB;AACA,4BAAIkE,MAAM6B,UAAU5F,KAAV,CAAgB,GAAhB,CAAV;AACA,4BAAI6F,OAAO9B,IAAI,CAAJ,EAAO/D,KAAP,CAAa,GAAb,CAAX;AACA,4BAAI8F,YAAYjB,iBAAhB,CAJG,CAIgC;AACnC,4BAAIkB,WAAWvB,cAAf,CALG,CAK4B;AAC/B,4BAAIwB,MAAM;AACNtC,mCAAOA,KADD;AAENqC,sCAAUA,QAFJ;AAGNE,qCAAS,eAAeJ,KAAK,CAAL,CAHlB;AAINK,sCAAU,KAJJ;AAKNJ,uCAAWA;AALL,yBAAV;AAOAE,4BAAIG,OAAJ,GAAc7D,KAAK0D,GAAL,EAAUI,WAAV,EAAd;AACA5F,2BAAG6F,cAAH,CAAkB;AACdP,uCAAWE,IAAIF,SADD;AAEdC,sCAAUC,IAAID,QAFA;AAGdE,qCAASD,IAAIC,OAHC;AAIdC,sCAAUF,IAAIE,QAJA;AAKdC,qCAASH,IAAIG,OALC;AAMdzF,qCAASA,SANK;AAOdc,kCAAMA,IAPQ;AAQd0B,sCAAUA;AARI,yBAAlB;AAUH;AACJ,iBArCG;AAsCJ1B,sBAAM,gBAAW,CAAE,CAtCf;AAuCJ0B,0BAAU,oBAAW,CAAE;AAvCnB,aAAR;AAyCH,SAhDG;AAiDJ1B,cAAM,gBAAW,CAAE,CAjDf;AAkDJ0B,kBAAU,oBAAW,CAAE;AAlDnB,KAAR;AAoDH,CA5DD;;AA8DA;;;;;;;AAOA,IAAMoD,MAAM,SAANA,GAAM,CAAUpB,GAAV,EAAexE,SAAf,EAAwBc,IAAxB,EAA8B0B,QAA9B,EAAwC;AAClDgC,UAAMA,OAAO,CAAb;AACAxE,gBAAUA,aAAW,UAAUT,GAAV,EAAe,CAAG,CAAvC;AACAuB,WAAOA,QAAQ,YAAY,CAAG,CAA9B;AACA0B,eAAWA,YAAY,YAAY,CAAG,CAAtC;;AAEApC,YAAQ;AACNC,aAAKzC,KAAKgI,GADJ;AAEN3D,gBAAQ,MAFF;AAGN3B,cAAM;AACJkE,iBAAKA;AADD,SAHA;AAMNxE,iBAAS,iBAAUT,GAAV,EAAe;AACpB,gBAAIsC,IAAItC,IAAIe,IAAZ;AACAL,oBAAQC,GAAR,CAAY,kBAAkB0E,KAAKC,SAAL,CAAehD,CAAf,CAA9B;AACA,gBAAIA,KAAKA,EAAEC,KAAF,IAAW,CAApB,EACA;AACE,oBAAIwD,MAAMzD,EAAEvB,IAAF,CAAOuF,IAAjB;AACA5F,wBAAQC,GAAR,CAAYoF,GAAZ;AACAxF,mBAAG6F,cAAH,CAAkB;AAChBP,+BAAWE,IAAIF,SADC;AAEhBC,8BAAUC,IAAID,QAFE;AAGhBE,6BAASD,IAAIC,OAHG;AAIhBC,8BAAUF,IAAIE,QAJE;AAKhBC,6BAASH,IAAIG,OALG;AAMhBzF,6BAASA,SANO;AAOhBc,0BAAMA,IAPU;AAQhB0B,8BAAUA;AARM,iBAAlB;AAUD;AACJ,SAxBK;AAyBN1B,cAAM,gBAAY,CAAG,CAzBf;AA0BN0B,kBAAU,oBAAY,CAAG;AA1BnB,KAAR;AA4BD,CAlCD;;AAsCAsD,OAAOC,OAAP,GAAiB;AACb9H,gBAAYA,UADC;AAEbmB,eAAWA,SAFE;AAGb0E,kBAAcA,YAHD;AAIb1D,aAASA,OAJI;AAKbwB,UAAMA,IALO;AAMbgE,SAAKA,GANQ;AAObnE,aAAQA,OAPK;AAQbM,wBAAmBA,kBARN;AASbnC,gBAAYA,UATC;AAUboB,kBAAcA,YAVD;AAWbD,kBAAcA,YAXD;AAYbO,oBAAeA;AAZF,CAAjB","file":"util.js","sourceRoot":"../../../../../../assets/script/wx/utils","sourcesContent":["var tokenMgr = require('tokenMgr');\nvar urls = require('config').urls;\nvar md5 = require('md5');\nvar config = require('config');\nvar global = require('../global/global');\nvar WXBizDataCrypt = require('WXBizDataCrypt');\n\nconst formatTime = date => {\n    const year = date.getFullYear()\n    const month = date.getMonth() + 1\n    const day = date.getDate()\n    const hour = date.getHours()\n    const minute = date.getMinutes()\n    const second = date.getSeconds()\n\n    return [year, month, day].map(formatNumber).join('/') + ' ' + [hour, minute, second].map(formatNumber).join(':')\n}\n\nconst formatNumber = n => {\n    n = n.toString()\n    return n[1] ? n : '0' + n\n}\n\nconst randomStr = n => { \n    const chars = \"0123456789abcdefghijklmnopqrstuvwxyz\".split('');\n    var res = \"\";\n    for (var i = 0; i < n; i++) {\n        res = res + chars[(Math.random() * 1e3 | 0) % chars.length];\n    }\n    return res;\n}\n\n// 获取本次登录的会话密钥\nconst getSession = function (callback) {\n    wx.login({\n        success: res => {\n            console.log('wx login success:', res);\n            let code = res.code;\n            wx.request({\n                url: 'https://api.weixin.qq.com/sns/jscode2session',\n                data: {\n                    appid: config.config.appid,\n                    secret: config.config.appsecret,\n                    js_code: code,\n                    grant_type: 'authorization_code'\n                },\n                success: res => {\n                    console.log('get session key success:', res);\n                    // self.session_key = res.data.session_key;\n                    config.sessionkey = res.data.session_key;\n                    if (callback && typeof callback == 'function') {\n                        callback();\n                    }\n                },\n                fail: res => {\n                    console.log('get session key fail:', res);\n                }\n            });\n        },\n        fail: res => {\n            console.log('wx login fail:', res);\n        }\n    });\n}\n\nconst decodeOpenId = function (res, callback) {\n    checkSession(function () {\n        console.log('config.sessionkey:', config.sessionkey);\n        if (config.sessionkey && config.sessionkey != '') {\n            let pc = new WXBizDataCrypt(config.config.appid, config.sessionkey);\n            let data = pc.decryptData(res.encryptedData, res.iv);\n            console.log('解密后openid: ', data);\n            if(data && data[\"openGId\"]){\n                // return data;\n                if (callback && typeof callback == 'function') {\n                    callback(data.openGId);\n                }\n            }\n        }\n    });\n}\n\nconst checkSession = function (callback) {\n    wx.checkSession({\n        success: res => {\n            console.log('check session success', res);\n            if (config.sessionkey == '') {\n                getSession(callback);\n            } else {\n                if (callback && typeof callback == 'function') {\n                    callback();\n                }\n            }\n            // if (res.errMsg != 'checkSession:ok') {\n            //     getSession(callback);\n            // } else if (res.errMsg == 'checkSession:ok') {\n                \n            // }\n        },\n        fail: res => {\n            console.log('check session fail', res);\n            getSession(callback);\n        }\n    });\n}\n/**\n * 不联网 本地获取OpenID \n * @param {*} code \n */\nconst getLocalOpenID = function(code){\n    wx.request({\n        url: 'https://api.weixin.qq.com/sns/jscode2session',\n        data: {\n            appid: config.config.appid,\n            secret: config.config.appsecret,\n            js_code: code,\n            grant_type: 'authorization_code'\n        },\n        success: res => {\n            console.log('get session key success:', res);\n            // self.session_key = res.data.session_key;\n            config.sessionkey = res.data.session_key;\n            config.UID = res.data.openid;\n\n        },\n        fail: res => {\n            console.log('get session key fail:', res);\n        }\n    });\n}\n\nconst reLogin =function(){\n    wx.login({\n        success:res=>{\n            var param = config.getParam();\n            param[\"appsign\"] = sign(param);\n            param[\"js_code\"] = res.code;\n            request({\n                url: config.urls.login,\n                data:param,\n                success: function (res) {\n                    console.log(\"login +\",res);\n                    if(res.data[\"uid\"]){\n                        var d = res.data;\n                        if (d && (d.ecode == 0 || d.ecode == 2)) {\n                            console.log(\"login +\",res)\n                            if(res.data[\"uid\"]){\n                                config.UID = res.data[\"uid\"] ;\n                            }\n                            if(res.data['sessionkey']){\n                                config.sessionkey = res.data.sessionkey;\n                            }\n                            reloginGetUserInfo();\n                        }\n                    }\n                },\n            })\n        },\n        fail:res=>{\n            console.log(res)\n        }\n    })\n};\n\nconst reloginGetUserInfo = function(){\n    var url = config.urls.user +\"/get_user\";\n    var param = {};//config.getParam();\n    request({\n        url: url,\n        data: param,\n        method: 'GET',\n        success:res=>{\n            //服务器存储的用户数据\n            console.log(\"getUserData\",res)\n            global.setUserDataInfo(res.data.data)\n        },\n    })\n};\n\nconst request = p => {\n    if(!!!config.gamecenter_link){\n        var fail = p.fail || function(err) {};\n        fail();\n        return;\n    }\n    var url = p.url;\n    var data = p.data || {};\n    var header = p.header || {};\n    var method = p.method || 'GET';\n    var dataType = p.dataType || \"\";\n    var success = p.success || function(res) {};\n    var fail = p.fail || function(err) {};\n    var complete = p.complete || function() {};\n    if (tokenMgr.checkToken()) {\n        header.token = tokenMgr.getToken();\n    }else{\n        //非登录接口\n        if(!data[\"js_code\"]){\n            reLogin();\n            return;\n        }\n    }\n    console.log(url,p,header.token)\n    wx.request({\n        url: url,\n        data: data,\n        header: header,\n        method: method,\n        dataType: dataType,\n        success: function(res) {\n            if(res.data[\"token\"]){                \n                tokenMgr.setToken(res.data.token);\n            }\n\n            if (res.statusCode != 200) {\n                console.error('response error:', res.statusCode);\n                return;\n            }\n\n            success(res);\n        },\n        fail: function(res){\n            console.log(\"fail\",res)\n            fail(res);\n            tokenMgr.setToken( null );\n        },\n        complete: complete\n    })\n}\n\n\nconst key = config.config.appsecret;\nconst appId = config.config.appid;\n\n/**\n * 微信支付签名\n * @param {*代签名object} p\n */\nconst sign = p => {\n    var list = new Array();\n    for (var item in p) {\n        var type = typeof p[item];\n        if (type == \"string\" || type == \"number\") {\n            var tmp = item + \"=\" + p[item];\n            list.push(tmp);\n        }\n    }\n    list.sort(function(o0, o1) {\n        return o0 > o1;\n    });\n    list.push(\"key=\" + key);\n    var res = list.join(\"&\");\n    console.log(\"sign_source:\" + res);\n    return md5.md5(res);\n}\n\nconst getXMLNodeValue = function(node_name, xml) {\n    console.log(\"xml:\" + xml);\n    var tmp = xml.split(\"<\" + node_name + \">\")\n    var _tmp = tmp[1].split(\"</\" + node_name + \">\")\n    return _tmp[0]\n};\n\nconst randomString = function() {\n    var chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678'; /****默认去掉了容易混淆的字符oOLl,9gq,Vv,Uu,I1****/\n    var maxPos = chars.length;\n    var pwd = '';\n    for (var i = 0; i < 32; i++) {\n        pwd += chars.charAt(Math.floor(Math.random() * maxPos));\n    }\n    return pwd;\n};\n\nconst createTimeStamp = function() {\n    return parseInt(new Date().getTime() / 1000) + ''\n};\n\n/**\n * 微信支付\n * @param {*} fee 支付额度，单位分\n * @param {*} success 支付成功\n * @param {*} fail 支付失败\n * @param {*} complete 支付完成\n */\nconst _pay = function(fee, success, fail, complete) {\n    fee = fee || 1;\n    success = success || function(res) {};\n    fail = fail || function() {};\n    complete = complete || function() {};\n\n    const url_unifiedOrder = urls.unifiedOrder;\n    const wx_unifiedOrder = \"https://api.mch.weixin.qq.com/pay/unifiedorder\";\n    request({\n        url: url_unifiedOrder,\n        data: {\n            fee: fee\n        },\n        success: function(res) {\n            console.log(\"UNIFIEDORDER:\" + JSON.stringify(res));\n            request({\n                url: wx_unifiedOrder,\n                data: res.data,\n                method: \"POST\",\n                success: function(res) {\n                    var xml = res.data;\n                    var return_code = getXMLNodeValue('return_code', xml.toString(\"utf-8\"));\n                    var returnCode = return_code.split('[')[2].split(']')[0];\n                    if (returnCode == 'FAIL') {\n                        var err_code_des = getXMLNodeValue('err_code_des', res.data.toString(\"utf-8\"))\n                        var errDes = err_code_des.split('[')[2].split(']')[0]\n                        fail();\n                    } else {\n                        var prepay_id = getXMLNodeValue('prepay_id', res.data.toString(\"utf-8\"));\n                        var tmp = prepay_id.split('[');\n                        var tmp1 = tmp[2].split(']');\n                        var timeStamp = createTimeStamp(); //时间戳\n                        var nonceStr = randomString(); //随机数\n                        var dat = {\n                            appId: appId,\n                            nonceStr: nonceStr,\n                            package: \"prepay_id=\" + tmp1[0],\n                            signType: \"MD5\",\n                            timeStamp: timeStamp,\n                        };\n                        dat.paySign = sign(dat).toUpperCase();\n                        wx.requestPayment({\n                            timeStamp: dat.timeStamp,\n                            nonceStr: dat.nonceStr,\n                            package: dat.package,\n                            signType: dat.signType,\n                            paySign: dat.paySign,\n                            success: success,\n                            fail: fail,\n                            complete: complete\n                        });\n                    }\n                },\n                fail: function() {},\n                complete: function() {}\n            });\n        },\n        fail: function() {},\n        complete: function() {}\n    });\n}\n\n/**\n * 微信支付\n * @param {*} fee 支付额度，单位分\n * @param {*} success 支付成功\n * @param {*} fail 支付失败\n * @param {*} complete 支付完成\n */\nconst pay = function (fee, success, fail, complete) {\n  fee = fee || 1;\n  success = success || function (res) { };\n  fail = fail || function () { };\n  complete = complete || function () { };\n\n  request({\n    url: urls.pay,\n    method: \"POST\",\n    data: {\n      fee: fee\n    },\n    success: function (res) {\n        var d = res.data;\n        console.log(\"pay response:\" + JSON.stringify(d));\n        if (d && d.ecode == 0)\n        {\n          var dat = d.data.args;\n          console.log(dat)\n          wx.requestPayment({\n            timeStamp: dat.timeStamp,\n            nonceStr: dat.nonceStr,\n            package: dat.package,\n            signType: dat.signType,\n            paySign: dat.paySign,\n            success: success,\n            fail: fail,\n            complete: complete\n          });\n        }\n    },\n    fail: function () { },\n    complete: function () { }\n  });\n}\n\n\n\nmodule.exports = {\n    formatTime: formatTime,\n    randomStr: randomStr,\n    randomString: randomString,\n    request: request,\n    sign: sign,\n    pay: pay,\n    reLogin:reLogin,\n    reloginGetUserInfo:reloginGetUserInfo,\n    getSession: getSession,\n    checkSession: checkSession,\n    decodeOpenId: decodeOpenId,\n    getLocalOpenID:getLocalOpenID,\n}"]}