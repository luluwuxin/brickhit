{"version":3,"sources":["../../../../../../assets/script/wx/login/assets/script/wx/login/gameWxLoad.js"],"names":["login","require","config","share","rank","ad","MSG","self","cc","Class","extends","Component","properties","onLoad","register","sys","platform","WECHAT_GAME","_rank","_share","loadFriendRankWidget","wxLoading","director","loadScene","loginScene","start","btn","find","console","log","on","event","rebtn","nameLoading","failWidget","active","wx","success","launcInfo","getLaunchOptionsSync","gamecenter_link","shareTicket","showGroupRank","res","code","getUseInfo","postAdvert","query","addFriend","fail","getOpenDataContext","openDataContext","postMessage","id","MessageID","ON_MSG_GET_GROUP_RANK_OPEN","node","runAction","sequence","delayTime","callFunc","friendRank","js","getComponent","initRank","failLogin","widget","loginBtnIn"],"mappings":"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","file":"gameWxLoad.js","sourceRoot":"../../../../../../assets/script/wx/login","sourcesContent":["// Learn cc.Class:\r\n//  - [Chinese] http://www.cocos.com/docs/creator/scripting/class.html\r\n//  - [English] http://www.cocos2d-x.org/docs/editors_and_tools/creator-chapters/scripting/class/index.html\r\n// Learn Attribute:\r\n//  - [Chinese] http://www.cocos.com/docs/creator/scripting/reference/attributes.html\r\n//  - [English] http://www.cocos2d-x.org/docs/editors_and_tools/creator-chapters/scripting/reference/attributes/index.html\r\n// Learn life-cycle callbacks:\r\n//  - [Chinese] http://www.cocos.com/docs/creator/scripting/life-cycle-callbacks.html\r\n//  - [English] http://www.cocos2d-x.org/docs/editors_and_tools/creator-chapters/scripting/life-cycle-callbacks/index.html\r\nvar login =  require('./login');\r\nvar config =  require('config');\r\nvar share =  require('../share/share');\r\nvar rank =  require('../rank/rank');\r\nvar ad=require('../ad/ad');\r\nvar MSG = require('../global/messageId');\r\nvar self = null;\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        // foo: {\r\n        //     // ATTRIBUTES:\r\n        //     default: null,        // The default value will be used only when the component attaching\r\n        //                           // to a node for the first time\r\n        //     type: cc.SpriteFrame, // optional, default is typeof default\r\n        //     serializable: true,   // optional, default is true\r\n        // },\r\n        // bar: {\r\n        //     get () {\r\n        //         return this._bar;\r\n        //     },\r\n        //     set (value) {\r\n        //         this._bar = value;\r\n        //     }\r\n        // },\r\n    },\r\n\r\n    // LIFE-CYCLE CALLBACKS:\r\n\r\n    onLoad () {\r\n        self = this;\r\n        self.register()\r\n        if(cc.sys.platform == cc.sys.WECHAT_GAME){\r\n            // wx.authorize({\r\n            //     success:res=>{\r\n            //        // this.wxLoading()\r\n            //     },\r\n            // })\r\n            self._rank = new rank();\r\n            self._share = new share();\r\n            self._rank.loadFriendRankWidget(self);\r\n            self.wxLoading()\r\n        }else{\r\n            cc.director.loadScene(config.loginScene, null);\r\n        }\r\n\r\n       // console.log(login)\r\n    },\r\n\r\n    start () {\r\n\r\n    },\r\n    register(){\r\n        var btn = cc.find(\"Canvas/loginSuccess/wxLogin\");\r\n        console.log(btn)\r\n        btn.on('click',function(event){\r\n            self.wxLoading()\r\n        },self);\r\n        var rebtn = cc.find(\"Canvas/loginFail/reLogin\");\r\n        rebtn.on('click',function(event){\r\n            self.wxLoading()\r\n        },self);\r\n    },\r\n    nameLoading(){\r\n        // var nameWidget = cc.find(\"Canvas/loginSuccess/nameTitle/nameString\");\r\n        // var edit = nameWidget.getComponent(cc.EditBox)\r\n        // config.useName = edit.string\r\n    },\r\n    wxLoading(){\r\n        //this.nameLoading()\r\n        if(self.failWidget){\r\n            self.failWidget.active = false;\r\n        }\r\n        // cc.director.loadScene(config.loginScene, null);\r\n        // return;\r\n        wx.login({\r\n            success:res=>{\r\n                var launcInfo = wx.getLaunchOptionsSync();\r\n                console.log(\"wx.getLaunchOptionsSync::\",launcInfo); \r\n                if(!!!config.gamecenter_link){\r\n                    if(launcInfo.shareTicket){\r\n                        //保存 进来的群的shareTicket\r\n                        config.shareTicket = launcInfo.shareTicket;\r\n                        self.showGroupRank();\r\n                    }else{\r\n                        cc.director.loadScene(config.loginScene, null);  \r\n                    }\r\n                    \r\n                    return;\r\n                };\r\n                login.login(res.code,function(res){\r\n                    login.getUseInfo();\r\n                    // var launcInfo = wx.getLaunchOptionsSync();\r\n                    // console.log(\"wx.getLaunchOptionsSync::\",launcInfo); \r\n                    ad.postAdvert();\r\n                    if (launcInfo && launcInfo[\"query\"] && launcInfo.query[\"uid\"]){\r\n                        self._share.addFriend(launcInfo.query[\"uid\"]);                        \r\n                        if (launcInfo.shareTicket){\r\n\r\n                            self.showGroupRank();\r\n                            \r\n                            // //通过shareTicket 获得群号，显示群排行信息\r\n                            // self._share.getShareInfo(launcInfo.shareTicket,function(openGId){\r\n                            //     //console.log(\"openGId\",openGId,self._rank)\r\n                            //     config.groupOpenGID = openGId;\r\n                            //     self._share.shareGroup(openGId);\r\n                            //     self._rank.getQunRank( openGId,function(res){\r\n                            //         if(res && res[\"data\"]){\r\n                            //             self.qunRankWidget.active = true\r\n                            //             var js = self.qunRankWidget.getComponent('rankQunLayer');\r\n                            //             js.init(res.data,function(){\r\n                            //                 cc.director.loadScene(config.loginScene, null);\r\n                            //             })\r\n                            //         }\r\n                            //     },\"true\");                   \r\n                            // })\r\n                            return;\r\n                        }                     \r\n                    }                \r\n                    cc.director.loadScene(config.loginScene, null);\r\n                },function(){\r\n                    cc.director.loadScene(config.loginScene, null);\r\n                    //console.log(\"failLoign show\")\r\n                    //self.failLogin();\r\n                })\r\n\r\n            },\r\n            fail:res=>{\r\n                //self.failLogin();\r\n                cc.director.loadScene(config.loginScene, null);\r\n            },\r\n        })\r\n    },\r\n    showGroupRank(){\r\n        if( typeof wx.getOpenDataContext != \"function\"){\r\n            // self._flyText(\"微信版本过低，请升级\")\r\n            cc.director.loadScene(config.loginScene, null);\r\n            return\r\n        }\r\n\r\n        let openDataContext = wx.getOpenDataContext();\r\n        openDataContext.postMessage({\r\n            id:MSG.MessageID.ON_MSG_GET_GROUP_RANK_OPEN,\r\n            shareTicket:config.shareTicket,\r\n        })\r\n        self.node.runAction(cc.sequence(cc.delayTime(0.5),cc.callFunc(function(){\r\n            self.friendRank.active = true;\r\n            var js = self.friendRank.getComponent('friendLayer');\r\n            js.initRank(\"true\",function(){\r\n                cc.director.loadScene(config.loginScene, null);    \r\n            });\r\n        })))\r\n    },\r\n    failLogin(){\r\n        // var widget = cc.find(\"Canvas/loginSuccess\");    \r\n        // widget.active = false;\r\n        if(self.failWidget){\r\n            self.failWidget.active = true;\r\n        }else{\r\n            var widget = cc.find(\"Canvas/loginFail\");\r\n            widget.active = true;\r\n            self.failWidget = widget;\r\n        }\r\n\r\n    },\r\n    loginBtnIn(){\r\n        cc.director.loadScene(config.loginScene, null);\r\n    }\r\n    // update (dt) {},\r\n});\r\n"]}