{"version":3,"sources":["matchManager.js"],"names":["match","require","share","MatchManager","cc","Class","statics","instance","getInstance","ctor","sys","platform","WECHAT_GAME","console","log","launchOpt","wx","getLaunchOptionsSync","target","matchData","layerIndex","_shareTicket","showShareMenu","withShareTicket","updateShareMenu","onShow","res","Object","keys","query","length","shareTicket","checkEnter","onHide","setTarget","update","getMatchInfo","data","code","showMatchHongbaoIcon","matchId","_id","starttime","endtime","limitscore","getQunRankInfo","setHasMatch","getShareInfo","success","showMatchRankLayer","encryptedData","fail","hongbaoIcon","active","on","showMatchShareLayer","matchShareWidget","getComponent","init","rankData","mobData","name","score","matchRankWidget","showMatchRankView","loadMatchHongbaoIcon","path","_loadPrefab","loadMatchShareWidget","loadMatchRankWidget","layer","loader","loadRes","Prefab","err","prefab","widget","instantiate","node","addChild","setLocalZOrder"],"mappings":"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","file":"matchManager.js","sourceRoot":"../../../../../../assets/script/wx/match","sourcesContent":["var match = require('match');\r\nvar share = require('share');\r\n\r\nvar MatchManager = cc.Class({\r\n    statics: {\r\n        instance: null,\r\n        getInstance: function () {\r\n            if (MatchManager.instance == null) {\r\n                MatchManager.instance = new MatchManager();\r\n            }\r\n            return MatchManager.instance;\r\n        }\r\n    },\r\n\r\n    ctor: function () {\r\n        if (cc.sys.platform == cc.sys.WECHAT_GAME) {\r\n            console.log('match manager be constructed');\r\n\r\n            this.launchOpt = wx.getLaunchOptionsSync();\r\n            console.log('match manager be created, launchOption:', this.launchOpt);\r\n\r\n            this.target = null;\r\n            this.matchData = null;\r\n            this.layerIndex = 18000;\r\n            this._shareTicket = null;\r\n\r\n            // 微信设置\r\n            wx.showShareMenu({\r\n                withShareTicket: true\r\n            });\r\n\r\n            // 设置 withShareTicket: true\r\n            wx.updateShareMenu({\r\n                withShareTicket: true\r\n            });\r\n\r\n            wx.onShow(res => {\r\n                if (!this.target) {\r\n                    console.log('wx show game false: no target');\r\n                    return;\r\n                }\r\n\r\n                console.log('wx show game again:', res);\r\n                if (Object.keys(res.query).length > 0) {\r\n                    this.launchOpt.query = res.query;\r\n                    this.launchOpt.shareTicket = res.shareTicket;\r\n                    console.log('on show launchOpt:', this.launchOpt);\r\n\r\n                    this.checkEnter();\r\n                }\r\n            });\r\n\r\n            wx.onHide(function () {\r\n                console.log('wx game is hide');\r\n            });\r\n        }\r\n    },\r\n\r\n    setTarget: function (target) {\r\n        this.target = target;\r\n    },\r\n\r\n    update: function () {\r\n        // 判断是否从群分享的卡片进来, 是的话就不向服务器请求match信息\r\n        if (this.checkEnter()) {\r\n            console.log('got match info from LaunchOption');\r\n            return;\r\n        }\r\n\r\n        console.log('getting match info from server .....');\r\n        // 主动向服务器获取match信息\r\n        match.getMatchInfo(data => {\r\n            // 201 为没有拿到比赛数据\r\n            if (!!data.code && data.code == 201) {\r\n                console.log('no match now');\r\n            } else {\r\n                // 拿到活动，游戏界面显示红包icon\r\n                this.showMatchHongbaoIcon(data);\r\n            }\r\n        });\r\n    },\r\n\r\n    /**\r\n     * LaunchOption: {\r\n     *      scene: number,\r\n     *      query: Object,\r\n     *      isSticky: boolean,\r\n     *      shareTicket: string\r\n     * }\r\n     */\r\n    checkEnter: function () {\r\n        console.log('check enter, matchid:', this.launchOpt.query.matchId);\r\n        if (!!this.launchOpt.query.matchId && !!this.launchOpt.shareTicket) {\r\n            // 是从群里卡片点进来的\r\n            this.matchData = {\r\n                _id: this.launchOpt.query.matchId,\r\n                starttime: this.launchOpt.query.starttime,\r\n                endtime: this.launchOpt.query.endtime,\r\n                limitscore: this.launchOpt.query.limitscore\r\n            };\r\n\r\n            this.getQunRankInfo(this.launchOpt.shareTicket);\r\n\r\n            return true;\r\n        } else {\r\n            return false;\r\n        }\r\n    },\r\n\r\n    getQunRankInfo: function (shareTicket) {\r\n        this._shareTicket = shareTicket;\r\n        match.setHasMatch(true);\r\n\r\n        // 之后使用这个接口\r\n        // share.shareGroup(shareTicket);\r\n\r\n        // 通过返回的shareTicket获取群相关的信息\r\n        wx.getShareInfo({\r\n            shareTicket: shareTicket,\r\n            success: res => {\r\n                console.log('get share info success, res:', res);\r\n\r\n                // 根据群里的信息初始化并显示MatchRankLayer\r\n                this.showMatchRankLayer(res.encryptedData);\r\n            },\r\n            fail: res => {\r\n                console.log('get share info fail, res:', res);\r\n            }\r\n        });\r\n    },\r\n    \r\n    showMatchHongbaoIcon: function (data) {\r\n        if (!!!this.target.hongbaoIcon) {\r\n            console.log('hongbaoIcon not be loaded yet');\r\n            return;\r\n        }\r\n\r\n        this.matchData = data;\r\n        this.target.hongbaoIcon.active = true;\r\n        this.target.hongbaoIcon.on('click', this.showMatchShareLayer, this);\r\n    },\r\n\r\n    showMatchShareLayer: function () {\r\n        this.target.matchShareWidget.active = true;\r\n        this.target.matchShareWidget.getComponent('matchLayer').init(this.matchData);\r\n    },\r\n\r\n    showMatchRankLayer: function (rankData) {\r\n        var mobData = [\r\n            {name: 'aaa', score: 100},\r\n            {name: 'bbb', score: 90},\r\n            {name: 'ccc', score: 80},\r\n            {name: 'ddd', score: 70},\r\n            {name: 'eee', score: 60},\r\n            {name: 'fff', score: 50},\r\n            {name: 'ggg', score: 40},\r\n            {name: 'hhh', score: 30},\r\n            {name: 'iii', score: 20},\r\n            {name: 'jjj', score: 10},\r\n        ];\r\n        this.target.matchRankWidget.active = true;\r\n        this.target.matchRankWidget.getComponent('matchRankLayer').init(this.matchData, mobData);\r\n    },\r\n\r\n    // 供外部调用, 主动来显示小比赛排行榜\r\n    showMatchRankView: function () {\r\n        if (!!!this._shareTicket) {\r\n            console.log('shareTicket not exist');\r\n            return;\r\n        }\r\n\r\n        this.getQunRankInfo(this._shareTicket);\r\n    },\r\n\r\n    loadMatchHongbaoIcon: function(target, name) {\r\n        var path = \"wx/matchRes/hongbaoIcon\";\r\n        name = name || \"hongbaoIcon\";\r\n        this._loadPrefab(path, target, name, this.layerIndex);\r\n    },\r\n\r\n    loadMatchShareWidget: function(target, name) {\r\n        var path = \"wx/matchRes/matchShareWidget\";\r\n        name = name || \"matchShareWidget\";\r\n        this._loadPrefab(path, target, name, this.layerIndex+1);\r\n    },\r\n\r\n    loadMatchRankWidget: function(target, name) {\r\n        var path = \"wx/matchRes/matchRankWidget\";\r\n        name = name || \"matchRankWidget\";\r\n        this._loadPrefab(path, target, name, this.layerIndex+2);\r\n    },\r\n\r\n    _loadPrefab: function(path, target, name, layer) {\r\n        cc.loader.loadRes(path, cc.Prefab, function(err, prefab) {\r\n            var widget = cc.instantiate(prefab);\r\n            target.node.addChild(widget);\r\n\r\n            widget.active = false;\r\n            target[name] = widget;\r\n\r\n            widget.setLocalZOrder(layer);\r\n        });\r\n    }\r\n});"]}