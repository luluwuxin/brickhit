{"version":3,"sources":["startup.js"],"names":["login","require","util","config","share","rank","global","consume","getInstance","ad","MSG","self","cc","Class","extends","Component","properties","onLoad","startupImage","find","node","toLoadScene","sys","platform","WECHAT_GAME","gamecenter_open","loginScene","director","preloadScene","start","_rank","_share","loadFriendRankWidget","wxLoading","finished","callFunc","loadScene","seq","sequence","delayTime","fadeOut","runAction","wx","success","launcInfo","getLaunchOptionsSync","console","log","gamecenter_link","getLocalOpenID","res","code","randStr","query","flag","IsRepeatRandString","addRandString","addGold","myAssist","setEnterGameRandStr","shareTicket","getUseInfo","postAdvert","addFriend","fail","showGroupRank","getOpenDataContext","openDataContext","postMessage","id","MessageID","ON_MSG_GET_GROUP_RANK_OPEN","friendRank","active","js","getComponent","initRank"],"mappings":"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","file":"startup.js","sourceRoot":"../../../../../../assets/script/wx/startup","sourcesContent":["import { request } from 'http';\r\n\r\n\r\nvar login =  require('login');\r\nvar util = require('util');\r\nvar config =  require('config');\r\nvar share =  require('../share/share');\r\nvar rank =  require('../rank/rank');\r\nvar global = require(\"global\");\r\nvar consume = require('consume').getInstance();\r\nvar ad=require('../ad/ad');\r\nvar MSG = require('../global/messageId');\r\nvar self = null;\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n\r\n    },\r\n\r\n    // LIFE-CYCLE CALLBACKS:\r\n\r\n    onLoad () {\r\n        self = this;\r\n        this.startupImage = cc.find('startup', this.node);\r\n        this.toLoadScene = null;\r\n\r\n        // 预加载场景\r\n        if(cc.sys.platform == cc.sys.WECHAT_GAME){\r\n            if (config.gamecenter_open) {\r\n                this.toLoadScene = 'gameWxLoading';\r\n            } else {\r\n                this.toLoadScene = config.loginScene;\r\n            }\r\n        } else {\r\n            this.toLoadScene = config.loginScene;\r\n        }\r\n        cc.director.preloadScene(this.toLoadScene, function () {\r\n        });\r\n\r\n    },\r\n\r\n    start () {\r\n        //var self = this;\r\n        if(cc.sys.platform == cc.sys.WECHAT_GAME){\r\n            self._rank = new rank();\r\n            self._share = new share();\r\n            self._rank.loadFriendRankWidget(self);\r\n            self.wxLoading();\r\n        }else{\r\n           self.loginScene(); \r\n        }\r\n\r\n    },\r\n    loginScene(){\r\n        var finished = cc.callFunc(function () {\r\n            cc.director.loadScene(self.toLoadScene);\r\n        });\r\n\r\n        var seq = cc.sequence(\r\n            cc.delayTime(1.5),\r\n            cc.fadeOut(0.5),\r\n            finished\r\n        );\r\n\r\n        this.startupImage.runAction(seq);\r\n    },\r\n    wxLoading(){\r\n        wx.login({\r\n            success:res=>{\r\n                var launcInfo = wx.getLaunchOptionsSync();\r\n                console.log(\"wx.getLaunchOptionsSync::\",launcInfo); \r\n                if(!!!config.gamecenter_link){\r\n                    util.getLocalOpenID(res.code);\r\n                    let randStr = launcInfo.query.randStr\r\n                    if(randStr){\r\n                        let flag = global.IsRepeatRandString(randStr)\r\n                        if(!!!flag){\r\n                            global.addRandString(randStr);\r\n                            consume.addGold(config.myAssist);\r\n                            global.setEnterGameRandStr(true);\r\n                        }\r\n                    }\r\n                    if(launcInfo.shareTicket){\r\n                        //保存 进来的群的shareTicket\r\n                        config.shareTicket = launcInfo.shareTicket;\r\n                        //self.showGroupRank();\r\n                        self.loginScene();\r\n                    }else{\r\n                        self.loginScene();\r\n                    }\r\n                    \r\n                    return;\r\n                };\r\n                login.login(res.code,function(res){\r\n                    login.getUseInfo();\r\n                    // var launcInfo = wx.getLaunchOptionsSync();\r\n                    // console.log(\"wx.getLaunchOptionsSync::\",launcInfo); \r\n                    ad.postAdvert();\r\n                    if (launcInfo && launcInfo[\"query\"] && launcInfo.query[\"uid\"]){\r\n                        self._share.addFriend(launcInfo.query[\"uid\"]);                        \r\n                        if (launcInfo.shareTicket){\r\n                            self.loginScene();\r\n                            //self.showGroupRank();\r\n                            \r\n                            // //通过shareTicket 获得群号，显示群排行信息\r\n                            // self._share.getShareInfo(launcInfo.shareTicket,function(openGId){\r\n                            //     //console.log(\"openGId\",openGId,self._rank)\r\n                            //     config.groupOpenGID = openGId;\r\n                            //     self._share.shareGroup(openGId);\r\n                            //     self._rank.getQunRank( openGId,function(res){\r\n                            //         if(res && res[\"data\"]){\r\n                            //             self.qunRankWidget.active = true\r\n                            //             var js = self.qunRankWidget.getComponent('rankQunLayer');\r\n                            //             js.init(res.data,function(){\r\n                            //                 cc.director.loadScene(config.loginScene, null);\r\n                            //             })\r\n                            //         }\r\n                            //     },\"true\");                   \r\n                            // })\r\n                            return;\r\n                        }                     \r\n                    }                \r\n                    self.loginScene();\r\n                },function(){\r\n                    self.loginScene();\r\n                    //console.log(\"failLoign show\")\r\n                    //self.failLogin();\r\n                })\r\n\r\n            },\r\n            fail:res=>{\r\n                //self.failLogin();\r\n                self.loginScene();\r\n            },\r\n        })\r\n    },\r\n    showGroupRank(){\r\n        if( typeof wx.getOpenDataContext != \"function\"){\r\n            // self._flyText(\"微信版本过低，请升级\")\r\n            self.loginScene();\r\n            return\r\n        }\r\n\r\n        let openDataContext = wx.getOpenDataContext();\r\n        openDataContext.postMessage({\r\n            id:MSG.MessageID.ON_MSG_GET_GROUP_RANK_OPEN,\r\n            shareTicket:config.shareTicket,\r\n        })\r\n        self.node.runAction(cc.sequence(cc.delayTime(0.5),cc.callFunc(function(){\r\n            self.friendRank.active = true;\r\n            var js = self.friendRank.getComponent('friendLayer');\r\n            js.initRank(\"true\",function(){\r\n                self.loginScene(); \r\n            });\r\n        })))\r\n    },\r\n    // update (dt) {},\r\n});\r\n"]}